openapi: 3.0.0
info:
  title: GeoHub API specification
  version: '1.0'
  description: |
    This documentation describes GeoHub's endpoints specification.

    Our core API is `/api/datasets` which allows users to search GeoHub datasets freely. It returns the response as GeoJSON feature collection and looks like similar to STAC response. Once you received the datasets details, you can handle them with our tiling servers. All our datasets are cloud optimised either `COG (Cloud Optimised GeoTiff)` or `PMTiles`.

    ## Raster datasets
    You can use our dynamic rater tiling servers - [titiler](https://titiler.undpgeohub.org/) and [titiler-dev](https://titiler-dev.undpgeohub.org/)

    ## Vector datasets
    Generally, vector tiles can be handled with [maplibre-gl-js](https://maplibre.org/projects/maplibre-gl-js/). But if the dataset's URL starts with `pmtiles://`, you can use [PMTiles Javascript API](https://protomaps.com/docs/frontends/maplibre) to add new protocol to your maplibre.

    ## Community maps API
    You can also get style.json of saved map style through `/api/style` endpoints.

    ## Authentication
    Some endpoints (for `GET`, `POST`, `PUT`, `DELETE` apis) with a padlock icon are required to sign in prior to using them. GeoHub uses either Azure Active Directory or GitHub authentication with Auth.js package. Auth.js package provides the following endpoints to [sign in](/auth/signIn) / [sign out](auth/signout). Please sign in first before trying swagger. If you use these endpoints without signing in, the result from the server might be different.

    Or you can use `token` query param to access with a valid access token for `/api` endpoints which have a padlock icon in swagger. A token can be issued through `/api/token` endpoint after you sign in with SSO. Default expiry time of a token is an hour, if you need a token with longer expiry time, please contact to us.

    ## Issues
    Please feel free to report any issues on GitHub from [here](https://github.com/UNDP-Data/geohub/issues). Or if you have any questions, please create a thread in GitHub's [discussions](https://github.com/UNDP-Data/geohub/discussions) page.
  contact:
    email: jin.igarashi@undp.org
    url: 'https://geohub.data.undp.org'
  license:
    name: BSD-3-Clause license
    url: 'https://github.com/UNDP-Data/geohub/blob/develop/LICENSE'
servers:
  - url: /api
    description: GeoHub APIs
paths:
  /datasets:
    get:
      summary: Datasets search API
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoJSONFeatureCollection'
      operationId: get-datasets
      description: |-
        This API returns the result as GeoJSON feature collection format and it contains links property at the bottom.

        The links will have the following patterns.

        - self = URL for the query itself
        - root = URL origin for this API
        - next = URL for next page
        - previous = URL for previous page

        You can use next or previous links to implement paging feature.

        Flexiblely to search by key/value of tags.

        {key}={value} e.g., sdg_goal=1 to filter where tag key is sdg_goal and value is 1. If multiple key/value are set, it will filter by OR operator. if you want to filter by SDG1 and 2, you can query like '&sdg_goal=1&sdg_goal=2'
      parameters:
        - schema:
            type: string
          in: query
          name: query
          description: 'free text to search in name, description'
        - schema:
            type: string
          in: query
          name: bbox
          description: 'you can filter the data by bounding box (minx, miny, maxx, maxy)'
        - schema:
            type: number
          in: query
          name: limit
          description: The number of datasets retrieved. default is 10
        - schema:
            type: string
          in: query
          name: offset
          description: Offset value for paging. default is 0
        - schema:
            type: string
          in: query
          name: extent
          description: Search by extent value
        - schema:
            type: string
          in: query
          name: granularity
          description: Search by granularity value
        - schema:
            type: string
          in: query
          name: keyword
          description: Search by keyword value
        - schema:
            type: string
            enum:
              - table
              - function
          in: query
          name: layertype
          description: Search by layertype of pg_tileserv
        - schema:
            type: string
          in: query
          name: resolution
          description: Search by resolution value
        - schema:
            type: string
            enum:
              - '1'
              - '2'
              - '3'
              - '4'
              - '5'
              - '6'
              - '7'
              - '8'
              - '9'
              - '10'
              - '11'
              - '12'
              - '13'
              - '14'
              - '15'
              - '16'
              - '17'
          in: query
          name: sdg_goal
          description: search by sdg_goal value
        - schema:
            type: string
          in: query
          name: sdg_target
          description: search by sdg_target value
        - schema:
            type: string
            enum:
              - earth-search
              - microsoft-pc
          in: query
          name: stac
          description: search by stac value
        - schema:
            type: string
          in: query
          name: theme
          description: search by theme value
        - schema:
            type: string
            enum:
              - pgtileserv
              - stac
          in: query
          name: type
          description: search by type value
        - schema:
            type: string
          in: query
          name: year
          description: search by year value
        - schema:
            type: boolean
            default: 'false'
          in: query
          name: staronly
          description: 'if true, only search for favourite datasets'
        - schema:
            type: string
            default: and
            enum:
              - and
              - or
          in: query
          name: queryoperator
          description: operator for query search. convert space to either 'and' or 'or'
        - schema:
            type: string
            default: and
            enum:
              - and
              - or
          in: query
          name: operator
          description: 'operator for tag search. '
        - schema:
            type: boolean
            default: 'false'
            enum:
              - 'true'
              - 'false'
          in: query
          name: mydata
          description: 'if true, only fetch datasets owned by login user'
      tags:
        - datasets
      security:
        - Azure AD authentication: []
        - API access token: []
    post:
      summary: Register a dataset feature to GeoHub
      operationId: post-datasets
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoJSONFeature'
      description: |-
        Register a dataset feature to GeoHub. If the dataset is already registered, the endpoint is going to update the dataset.

        Steps to register a dataset through this endpoint

        1.Authenticate to GeoHub

        The endpoint requires to be authenticated. You can sign in to GeoHub through your browser if you use swagger. Otherwise, please use `/api/token` endpoint to generate an access token.

        2.Create body for registration.

        It is basically the same feature of `/api/datasets` endpoint required to pass to POST api. You need to fill all information properly to register a dataset. 

        The below JSON is the basic structure of Feature Object. `type` must be `Feature`, and you need to add coordinates at `geometry` property. Normally, BBOX is used for it.

        ```
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
            ]
          },
          "properties": {
          }
        }
        ```

        In terms of `properties`, the below table shows which property is essential to register.

        | Property | Required | Description |
        |---|---|---|
        | `id` | Y | MD5 Hash key generated from url |
        | `url` | Y | URL of a blob. SAS Token for blob storage access is not needed. If PMTiles, `pmtiles://` protocol is required. |
        | `name` | Y | title of a dataset. |
        | `description` | Y | description of a dataset. Write it as details as possible. |
        | `is_raster` | Y | true: raster dataset, false: vector dataset |
        | `license` | Y | Open data license name |
        | `access_level` | Y | 1: Private, 2: Organization, 3: Public |
        | `createdat` | N | Not required for registration, but required for updating |
        | `created_user` | N | Not required for registration, but required for updating |
        | `updatedat` | N | Not required for registration |
        | `updated_user` | N | Not required for registration |
        | `tags` | Y | See next section for further details |
        | `no_stars` | N | Not required for registration |
        | `permission` | N | Not required for registration |
        | `is_star` | N | Not required for registration |
        | `links` | N | Not required for registration |


        3.Tag registrations

        Particularly, tags are important to identify a dataset. The below table gives you an overview of tags used in GeoHub.

        | key | required | description |
        |---|---|---|
        | `type` | Y | `azure` value is for COG/PMTiles dataset. `pgtileserv` value is needed for pg_tileserv layer. `stac` is required for STAC collection or catalog. |
        | `schema` | N | Only needed for `type=pgtileserv`. Schema name for a dataset|
        | `table ` | N | Only needed for `type=pgtileserv`. Table name for a dataset |
        | `layertype` | N | Only needed for `type=pgtileserv`. either `table` or `function` |
        | `id` | N | Only needed for `type=pgtileserv`. id of pg_tileserv layer |
        | `provider` | Y | at least a provider name is required. You can add many provider tag as you wish. |
        | `extent` | N | If it is global data, `Global` value can be added |
        | `continent` | N | If it is not global data, continent tag like `Africa` is recommended to be added. See `/api/continents` api for available values. |
        | `region` | N | If it is not global data, region tag like `Sub-Saharan Africa` is recommended to be added. See `/api/regions` api for available values. |
        | `country` | N | If it is not global data, country tag like `KEN` is recommended to be added. See `/api/countries` api for available values. You can add many country tag as you wish. |
        | `sdg_goal` | N | If a dataset is related to any SDGs, the number like `1` for poverty can be added. You can add many sdg_goal tag as you wish. |
        | `unit` | N | If raster dataset, unit tag is recommended to be added. |
        | `year` | N | If applicable, `year` tag can be added. |
        | `resolution` | N | If applicable, `resolution` tag can be added. |


        For STAC collection's registration, it is recommended to use STAC management tool in GeoHub. Tags required for STAC are not covered by the above table.

        For pg_tileserv registration/deletion, it is also recommended to use pg_tileserv layer management tool in GeoHub.

        The best way to know which tags are essential for a dataset is to search a dataset in GeoHub. The below is an example dataset URLs for each type of a dataset.

        - [Raster dataset (COG)](/api/datasets/241c5b17f396f114ad6f9063d07762b8)
        - [Vector dataset (PMTiles)](/api/datasets/196af310ffb45117cb4f091fa5d98705)
        - [Vector dataset (pg_tileserv)](/api/datasets/320cf4ffcf6414a68b428f14a5728053)
        - [STAC Collection (Catalog)](/api/datasets/351155bfc6f45c2ae47e7cbb4f439a47)
        - [STAC Catalog (Catalog)](/api/datasets/e696b278429ed1ee0579e6257df1ca59)
        - [STAC Collection (API)](/api/datasets/c47e79d248510ba2d397b76972eb8a83)

        4.Register a dataset with access token

        Once you have made all properties required for your dataset, you can use the following template command to register your dataset into the database.

        ```
        curl -X 'POST' \
          'https://geohub.data.undp.org/api/datasets?token={your generated token}' \
          -H 'accept: application/json' \
          -H 'Content-Type: application/json' \
          -d '{
          "type": "string",
          "geometry": {
            "type": "string",
            "coordinates": [
            ]
          },
          "properties": {
            "id": "string",
            "url": "string",
            "name": "string",
            "description": "string",
            "is_raster": true,
            "license": "string",
            "access_level": 0,
            "tags": [
              {
                "key": "type",
                "value": "azure"
              }
            ]
          }
        }'
        ```
      security:
        - Azure AD authentication: []
        - API access token: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeoJSONFeature'
      tags:
        - datasets
  '/datasets/{id}':
    parameters:
      - $ref: '#/components/parameters/dataset_id'
    get:
      summary: Get dataset feature by ID
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoJSONFeature'
      operationId: get-datasets-id
      description: get dataset feature by dataset ID
      tags:
        - datasets
      security:
        - Azure AD authentication: []
        - API access token: []
    delete:
      summary: Delete dataset by ID
      operationId: delete-datasets-id
      responses:
        '200':
          description: OK
      description: Delete dataset feature by dataset ID. This endpoint is required to sign in.
      tags:
        - datasets
      security:
        - Azure AD authentication: []
        - API access token: []
  '/datasets/{id}/table/layers/{layer}.{format}':
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Dataset ID
      - schema:
          type: string
        name: layer
        in: path
        required: true
        description: a layer ID. This should be equivalent to maplibre's source layer ID.
      - schema:
          type: string
          default: json
          enum:
            - json
            - csv
            - geojson
            - xlsx
        name: format
        in: path
        required: true
        description: 'Table format either json or csv or geojson or xlsx. default is json. '
    get:
      summary: Query attribute table for a layer
      tags:
        - datasets
      responses:
        '200':
          description: |-
            OK

            Attribute table data according to the format specifed in query param.

            If format is either json or geojson, it returns links and pages properties. If it is csv, it returns text/csv file. If json is selected as format, it omit geometry property from geojson.
          content:
            application/json:
              schema:
                type: object
                properties:
                  features:
                    type: array
                    x-stoplight:
                      id: dh8mjwf83l64t
                    items:
                      $ref: '#/components/schemas/GeoJSONFeature'
                  links:
                    type: array
                    x-stoplight:
                      id: w14b5l3y47id2
                    items:
                      $ref: '#/components/schemas/Link'
                  pages:
                    type: object
                    x-stoplight:
                      id: tygpber41ki1g
                    properties:
                      totalCount:
                        type: integer
                        x-stoplight:
                          id: cmol4zimxjoyq
                      totalPages:
                        type: integer
                        x-stoplight:
                          id: f4uftw55r0u46
                      currentPage:
                        type: integer
                        x-stoplight:
                          id: fc7aq09023798
        '400':
          description: |-
            Bad Request

            It returns 400 error in the following conditions:

            - If it is a raster layer
            - If layer does not exist in vector tiles
            - If bbox text does not align with minx, miny, maxx, maxy format
            - If format is invalid format
            - If limit or offset are not number
            - If sortby is wrong format, or specify the wrong field name
        '404':
          description: |-
            Not Found

            It returns 404 error in the following conditions:

            - If no dataset exists in the ID specifed
            - If no flatgeobuf exists to the dataset
          headers: {}
      operationId: get-datasets-id-attributes-layer
      description: |-
        This endpoint is to provide a capability to query attribute table for a vector layer. Currently, it is not available for raster layer.

        `query` param is to scan all properties to return any matched features. If you want to filter by specific columns, please use `cql_filter` instead.

        Use `cql_filter` to filter by advanced search. `cql_filter` only supports the following operators:

        `EQUAL TO [ = ]`, `LESS THAN [ < ]`, `LESS THAN OR EQUAL TO [ <= ]`, `GREATER THAN [ > ]`, `GREATER THAN OR EQUAL TO [ >= ]`, `IS NULL`, `LIKE`, `IN`, `NOT IN`, `BETWEEN aaa AND bbb`, `NOT [ <> ]`

        each condition can be concatenated by either `AND`, `OR`. operators should be capital letters.

        The below are examples of cql_filter for each operator.

        - `type_of_facility = 'Primary School'`
        - `student_number < 714`
        - `student_number <= 714`
        - `student_number > 782`
        - `student_number >= 782`
        - `condition IS NULL`
        - `facility_name LIKE EP`
        - `type_of_facility IN ('Primary School')`, `type_of_facility IN ('Primary School', 'Secondary School')`
        - `student_number NOT IN (701, 782)`
        - `student_number BETWEEN 600 AND 800`, `student_number BETWEEN 600 AND 800 AND type_of_facility = Secondary school`
        - `availability <> 'Regularly'`
      security:
        - Azure AD authentication: []
        - API access token: []
      parameters:
        - schema:
            type: string
          in: query
          name: query
          description: optional. text to query attribute table.
        - schema:
            type: integer
            default: 1000
          in: query
          description: optional. default is 1000.
          name: limit
        - schema:
            type: integer
            default: 0
          in: query
          name: offset
          description: optional. default is 0. Use it for pagination
        - schema:
            type: string
          in: query
          name: bbox
          description: 'optional. bbox (minx, miny, maxx, maxy) for filtering by geospatial extent. default is from metadata json'
        - schema:
            type: string
          in: query
          name: sortby
          description: 'optional. sorting column. format should be `{field name},{asc|desc}`'
        - schema:
            type: string
          in: query
          name: cql_filter
          description: optional. CQL filter to search data
        - schema:
            type: boolean
            default: 'false'
          in: query
          name: compress
          description: 'optional. default is false. If true, compress response as gzip using compress api. Only available for either json or geojson format.'
  /swagger/spec.json:
    get:
      summary: Get open API JSON definition
      responses: {}
      operationId: get-swagger-spec.json
      description: Get open API JSON definition
      tags:
        - swagger
components:
  schemas:
    Tag:
      title: Tag
      x-stoplight:
        id: um38sy7bphx89
      type: object
      properties:
        key:
          type: string
        value:
          type: string
        count:
          type: number
      required:
        - key
        - value
    QueryOperator:
      title: QueryOperator
      type: string
      enum:
        - and
        - or
    TagSearchOperator:
      title: TagSearchOperator
      type: string
      enum:
        - and
        - or
    SidebarPosition:
      title: SidebarPosition
      type: string
      enum:
        - left
        - right
    ClassificationMethodTypes:
      title: ClassificationMethodTypes
      type: string
      enum:
        - e
        - q
        - 'n'
        - l
    ResamplingMethodTypes:
      title: ResamplingMethodTypes
      type: string
      enum:
        - nearest
        - linear
    OverlapPriority:
      title: OverlapPriority
      type: string
      enum:
        - always
        - never
        - cooperative
    LinePattern:
      title: LinePattern
      type: string
      enum:
        - solid
        - dash
        - dash-dot
        - dot
    Link:
      title: Link
      x-stoplight:
        id: 758pae8gfhqq8
      type: object
      properties:
        rel:
          type: string
        type:
          type: string
        href:
          type: string
    GeoJSONFeature:
      type: object
      x-examples: {}
      description: GeoJSON feature object for GeoHub
      properties:
        type:
          type: string
        geometry:
          type: object
          properties:
            type:
              type: string
            coordinates:
              type: array
              items:
                type: number
        properties:
          type: object
          properties:
            id:
              type: string
            url:
              type: string
            name:
              type: string
            description:
              type: string
            is_raster:
              type: boolean
            license:
              type: string
            access_level:
              type: integer
            createdat:
              type: string
            created_user:
              type: string
            updatedat:
              type: string
            updated_user:
              type: string
            tags:
              type: array
              items:
                $ref: '#/components/schemas/Tag'
            no_stars:
              type: integer
            permission:
              type: integer
            is_star:
              type: boolean
            links:
              type: array
              items:
                $ref: '#/components/schemas/Link'
    GeoJSONFeatureCollection:
      type: object
      x-examples: {}
      description: GeoJSON FeatureCollection object for GeoHub
      properties:
        type:
          type: string
        features:
          type: array
          items:
            $ref: '#/components/schemas/GeoJSONFeature'
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'
        pages:
          type: object
          properties:
            totalCount:
              type: integer
            totalPages:
              type: integer
            currentPage:
              type: integer
    DatasetLayerStyle:
      title: DatasetLayerStyle
      x-stoplight:
        id: 3edd696171c73
      type: object
      description: Dataset style definition
      x-examples: {}
      properties:
        dataset_id:
          type: string
          description: dataset ID
        layer_id:
          type: string
        layer_type:
          type: string
          description: 'Layer type. fill, line, symbol, circle, heatmap, raster'
        source:
          type: object
          description: Maplibre source object
        style:
          type: object
          description: Maplibre layer style object
        colormap_name:
          type: string
          description: Colormap name if applicable
        classification_method:
          type: string
          description: Classification method if applicable
        classification_method_2:
          type: string
          x-stoplight:
            id: s5ozu37b48b7z
          description: 'classification method if there are two classification settings (icon size, line width) apart from color.'
        createdat:
          type: string
        created_user:
          type: string
        updatedat:
          type: string
        updated_user:
          type: string
      required:
        - dataset_id
        - layer_id
        - layer_type
        - source
        - style
        - createdat
        - created_user
    stac:
      title: stac
      x-stoplight:
        id: 51hxmfzs5mtju
      type: object
      description: STAC API/Catalog object
      x-examples:
        API:
          id: microsoft-pc
          name: Microsoft Planetary Computer
          url: 'https://planetarycomputer.microsoft.com/api/stac/v1'
          type: api
        Catalog:
          id: maxar-opendata
          name: Maxar Open Data
          url: 'https://maxar-opendata.s3.amazonaws.com/events/catalog.json'
          type: catalog
          providers:
            - Maxar Technologies
      properties:
        id:
          type: string
          description: STAC ID
        name:
          type: string
          x-stoplight:
            id: v1jc6kp2gikli
          description: STAC name
        url:
          type: string
          x-stoplight:
            id: eyl8a37kvp6ga
          description: API URL or catalog.json URL
        type:
          type: string
          x-stoplight:
            id: uaal8dmp1wuao
          description: either 'api' or 'catalog'
        providers:
          type: array
          x-stoplight:
            id: ape451kvnptqq
          description: list of provider names
          items:
            x-stoplight:
              id: olhqv5auy83ir
            type: string
        createdat:
          type: string
          x-stoplight:
            id: 124oktg1ynf9h
        created_user:
          type: string
          x-stoplight:
            id: a1bmx85anum4o
        updatedat:
          type: string
          x-stoplight:
            id: 2dgcrqaraoc0k
        updated_user:
          type: string
          x-stoplight:
            id: hscqetpry1rqr
      required:
        - id
        - name
        - url
        - type
        - createdat
        - created_user
  parameters:
    lon:
      name: lon
      in: path
      required: true
      schema:
        type: number
        default: 0
      description: longitude
    lat:
      name: lat
      in: path
      required: true
      schema:
        type: number
        default: 0
      description: latitude
    zoom:
      name: zoom
      in: path
      required: true
      schema:
        type: number
        default: 0
        minimum: 0
        maximum: 22
      description: zoom level
    width:
      name: width
      in: path
      required: true
      schema:
        type: integer
        default: 300
      description: image width (pixel)
    height:
      name: height
      in: path
      required: true
      schema:
        type: number
        default: 200
      description: image height (pixel)
    bbox:
      name: bbox
      in: path
      required: true
      schema:
        type: string
        example: '-4.04296875,-15.114552871944102,48.69140625,19.476950206488414'
      description: 'bbox (minx, miny, maxx, maxy)'
    bearing:
      name: bearing
      in: path
      required: true
      schema:
        type: number
        default: 0
      description: bearing
    pitch:
      name: pitch
      in: path
      required: true
      schema:
        type: number
        default: 0
      description: pitch
    format:
      name: format
      in: path
      required: true
      schema:
        type: string
        default: png
        enum:
          - png
          - jpeg
          - webp
      description: 'Supported format (jpeg, png, webp)'
    ratio:
      name: ratio
      in: query
      required: false
      schema:
        type: integer
        enum:
          - 1
          - 2
        default: 1
      description: ratio. either 1 or 2. Default is 1
    dataset_id:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Dataset ID
    maplibre_layer_type:
      name: type
      in: path
      required: true
      schema:
        type: string
        enum:
          - fill
          - line
          - symbol
          - circle
          - heatmap
          - fill-extrusion
          - raster
      description: 'Maplibre layer type (fill, line, symbol, circle, heatmap, raster)'
    maplibre_layer_id:
      name: layer
      in: path
      required: true
      schema:
        type: string
      description: 'Band name if it is raster, layer ID if it is vector.'
    maplibre_layer_id_optional:
      name: layer
      in: query
      required: false
      schema:
        type: string
      description: 'Band name if it is raster, layer ID if it is vector.'
    maplibre_layer_type_optional:
      name: type
      in: query
      required: false
      schema:
        type: string
        enum:
          - fill
          - line
          - symbol
          - circle
          - heatmap
          - fill-extrusion
          - raster
      description: 'Maplibre layer type (fill, line, symbol, circle, heatmap, raster)'
    storymap_id:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Storymap UUID
  securitySchemes:
    Azure AD authentication:
      type: http
      scheme: oauth
      description: Access to /auth/signin to sign in to Azure AD with your UNDP account.
    API access token:
      name: token
      type: apiKey
      in: query
  responses: {}
