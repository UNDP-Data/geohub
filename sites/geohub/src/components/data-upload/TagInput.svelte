<script lang="ts">
  import { createEventDispatcher } from 'svelte'
  import { initTippy } from '$lib/helper'
  import type { Tag } from '$lib/types/Tag'
  import { debounce } from 'lodash-es'
  import Notification from '$components/controls/Notification.svelte'
  import { hideAll } from 'tippy.js'
  import { tagInputValues } from '$lib/constants'

  const dispatch = createEventDispatcher()

  let tagList: Tag[]

  const tippy = initTippy({
    placement: 'left-end',
    onTrigger: async () => {
      tagList = await getTags()
      filterTagList = tagList
    },
  })
  let tooltipContent: HTMLElement

  let nodeRef: HTMLDivElement
  export let tag: Tag = {
    key: '',
    value: '',
  }
  export let isAdd = false
  let query = ''
  let filterTagList: Tag[] = []

  const handleDeleted = () => {
    nodeRef.parentNode.removeChild(nodeRef)
    dispatch('deleted', {
      tag,
    })
  }

  const handleAdded = () => {
    dispatch('added', {
      tag,
    })
  }

  const getTags = async () => {
    if (!tag.key) {
      return []
    }
    const res = await fetch(`/api/tags?key=${tag.key}`)
    const json = await res.json()
    let tags: Tag[] = []
    if (json[tag.key]) {
      tags = json[tag.key]
    }
    return tags
  }

  $: query, handleSearch()
  const handleSearch = debounce(() => {
    if (query.length === 0) {
      filterTagList = tagList
    } else {
      filterTagList = tagList.filter((t) => t.value.toLowerCase().indexOf(query.toLowerCase()) !== -1)
    }
  }, 300)

  const handleTagClicked = (value: string) => {
    tag.value = value
    hideAll()
  }

  const handleEnterKey = (e: KeyboardEvent) => {
    if (e.key === 'Enter') {
      // eslint-disable-next-line @typescript-eslint/ban-ts-comment
      // @ts-ignore
      e.target.click()
    }
  }
</script>

<div
  class="is-flex is-flex-direction-row py-1 px-0"
  bind:this={nodeRef}>
  <div class="select {tag.key ? 'is-success' : 'is-danger'} pr-1 is-fullwidth tag-key">
    <select bind:value={tag.key}>
      <option value="">Select a key</option>
      {#each tagInputValues as key}
        <option value={key.key}>{key.label}</option>
      {/each}
    </select>
  </div>
  <div class="pr-1 tag-value">
    <input
      class="input {tag.value ? 'is-success' : 'is-danger'}"
      type="text"
      placeholder="type word for tag"
      bind:value={tag.value} />
  </div>
  <div class="pr-1">
    <button
      type="button"
      class="button"
      use:tippy={{ content: tooltipContent }}
      disabled={tag.key ? false : true}>
      <span class="icon is-small">
        <i class="fa-solid fa-magnifying-glass" />
      </span>
    </button>
    {#if tag.key}
      <nav
        class="panel tooltip"
        bind:this={tooltipContent}>
        <p class="panel-heading">
          {tagInputValues.find((t) => t.key === tag.key)?.label ?? tag.key}
        </p>
        <div class="panel-block">
          <p class="control has-icons-left">
            <input
              class="input"
              type="text"
              placeholder="Search"
              bind:value={query} />
            <span class="icon is-left">
              <i
                class="fas fa-search"
                aria-hidden="true" />
            </span>
            {#if query.length > 0}
              <!-- svelte-ignore a11y-click-events-have-key-events -->
              <span
                class="clear-button"
                on:click={() => (query = '')}>
                <i class="fas fa-xmark sm" />
              </span>
            {/if}
          </p>
        </div>
        <div class="tag-list">
          {#if filterTagList?.length > 0}
            {#each filterTagList as t}
              <!-- svelte-ignore a11y-missing-attribute -->
              <a
                class="panel-block"
                on:click={() => {
                  handleTagClicked(t.value)
                }}
                on:keydown={handleEnterKey}>
                <span class="panel-icon">
                  <i
                    class="fa-solid fa-tag"
                    aria-hidden="true" />
                </span>
                {t.value} ({t.count})
              </a>
            {/each}
          {:else}
            <div class="p-2">
              <Notification
                type="info"
                showCloseButton={false}>
                No tag found. Try another keyword.
              </Notification>
            </div>
          {/if}
        </div>
      </nav>
    {/if}
  </div>
  {#if isAdd}
    <div>
      <button
        type="button"
        class="button"
        disabled={tag.key && tag.value ? false : true}
        on:click={handleAdded}>
        <span class="icon is-small">
          <i class="fa-solid fa-plus" />
        </span>
      </button>
    </div>
  {:else}
    <div>
      <button
        type="button"
        class="button"
        disabled={tag.key && tag.value ? false : true}
        on:click={handleDeleted}>
        <span class="icon is-small">
          <i class="fa-solid fa-trash-can" />
        </span>
      </button>
    </div>
  {/if}
</div>

<style lang="scss">
  @import 'tippy.js/dist/tippy.css';
  @import 'tippy.js/themes/light.css';

  .tag-key {
    width: 200px;
  }
  .tag-value {
    width: 70%;
  }

  .tooltip {
    .clear-button {
      position: absolute;
      top: 0.6rem;
      right: 0.8rem;
      cursor: pointer;
      color: gray;
    }

    .tag-list {
      max-height: 250px;
      overflow-y: auto;
    }
  }
</style>
