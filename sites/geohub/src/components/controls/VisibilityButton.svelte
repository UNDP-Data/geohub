<script lang="ts">
  import { cloneDeep } from 'lodash-es'
  import type { Layer } from '$lib/types'
  import { layerList, map } from '$stores'

  export let layer: Layer

  const layerId = layer.id

  $: visibility = getVisibility()

  const getVisibility = (): 'visible' | 'none' => {
    const layerStyle = $map.getStyle().layers.find((l) => l.id === layer.id)
    let visibility: 'visible' | 'none' = 'visible'
    if (layerStyle.layout && layerStyle.layout.visibility) {
      visibility = layerStyle.layout.visibility
    }
    return visibility
  }

  const toggleVisibility = () => {
    visibility = visibility === 'visible' ? 'none' : 'visible'
    $map.setLayoutProperty(layerId, 'visibility', visibility)

    const layerClone = cloneDeep(layer)
    const layerIndex = $layerList.findIndex((layer) => layer.id === layerId)
    $layerList[layerIndex] = layerClone

    if (layer.children && layer.children.length > 0) {
      layer.children.forEach((child) => {
        if (!$map.getLayer(child.id)) return
        $map.setLayoutProperty(child.id, 'visibility', visibility)
      })
    }
  }

  const handleKeyDown = (event: KeyboardEvent) => {
    if (event.key === 'Enter') {
      toggleVisibility()
    }
  }
</script>

<div
  class="has-tooltip-bottom has-tooltip-arrow"
  data-tooltip={`${visibility === 'visible' ? 'Show Layer' : 'Hide Layer'}`}>
  <div
    class="icon-selected"
    title="Toggle Visibility"
    aria-label="Toggle Visibility"
    tabindex="0"
    role="button"
    on:click={() => toggleVisibility()}
    on:keydown={handleKeyDown}>
    <i class="fa-solid {visibility === 'visible' ? 'fa-eye' : 'fa-eye-slash'} fa-sm" />
  </div>
</div>

<style lang="scss">
  @import '../../styles/button-icons-selected.scss';
</style>
